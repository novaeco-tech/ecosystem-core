name: NovaEco Core CI

on:
  pull_request:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # Job 1: Detect changes in components
  changed-files:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      auth: ${{ steps.filter.outputs.auth }}
      website: ${{ steps.filter.outputs.website }}
      integration: ${{ steps.filter.outputs.integration }}
      e2e: ${{ steps.filter.outputs.e2e }}
      performance: ${{ steps.filter.outputs.performance }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            api: ['api/**']
            auth: ['auth/**']
            website: ['website/**']
            integration:
              - 'api/**'
              - 'auth/**'
              - 'tests/integration/**'
              - '.devcontainer/docker-compose.yml'
            e2e:
              - 'api/**'
              - 'auth/**'
              - 'tests/e2e/**'
              - '.devcontainer/docker-compose.yml'
            performance:
              - 'api/**'
              - 'auth/**'

  # Job 2: Unit Test API (L5)
  test-api:
    needs: changed-files
    if: ${{ needs.changed-files.outputs.api == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/novaeco-tech/dev-python:latest
      options: --user root
    steps:
      - uses: actions/checkout@v4
      - name: Install Dependencies
        run: pip install -r api/requirements.txt
      - name: Run Unit Tests
        run: cd api && pytest tests/unit

  # Job 3: Unit Test Auth (L5)
  test-auth:
    needs: changed-files
    if: ${{ needs.changed-files.outputs.auth == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/novaeco-tech/dev-python:latest
      options: --user root
    steps:
      - uses: actions/checkout@v4
      - name: Install Dependencies
        run: pip install -r auth/requirements.txt
      - name: Run Unit Tests
        run: cd auth && pytest tests/unit

  # Job 4: Unit Test Website (L5)
  test-website:
    needs: changed-files
    if: ${{ needs.changed-files.outputs.website == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/novaeco-tech/dev-node:latest
      options: --user root
    steps:
      - uses: actions/checkout@v4
      - name: Install Dependencies
        run: cd website && npm ci
      - name: Run Tests
        run: cd website && npm test -- tests/unit

  # Job 5: Integration Tests (L4 & L2)
  test-integration:
    needs: changed-files
    if: ${{ needs.changed-files.outputs.integration == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start Environment
        run: docker compose -f .devcontainer/docker-compose.yml up -d --build --wait

      # --- 1. Root Integration (L2 System Wiring) ---
      - name: Run Root Integration (Kernel Bundle)
        run: |
          # Install root test deps into the 'api' container (acting as test runner)
          docker compose -f .devcontainer/docker-compose.yml exec -T api \
            pip install -r /workspace/tests/integration/requirements.txt
          
          # Execute Root Tests
          docker compose -f .devcontainer/docker-compose.yml exec -T api \
            pytest /workspace/tests/integration

      # --- 2. API Component Integration (L4 Local) ---
      - name: Run API Local Integration
        run: |
          # The API container is already set up with requirements-dev.txt via docker-compose command
          docker compose -f .devcontainer/docker-compose.yml exec -T api \
            pytest /workspace/api/tests/integration

      # --- 3. Auth Component Integration (L4 Local) ---
      - name: Run Auth Local Integration
        run: |
          # Execute inside the AUTH container to verify local DB/Contract logic
          docker compose -f .devcontainer/docker-compose.yml exec -T auth \
            pytest /workspace/auth/tests/integration

  # Job 6: E2E Tests (L3 & L1) - UPDATED
  test-e2e:
    needs: changed-files
    if: ${{ needs.changed-files.outputs.e2e == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python (Host)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install E2E Dependencies (Host)
        run: |
          pip install -r tests/e2e/requirements.txt
          playwright install --with-deps

      - name: Start Environment
        run: docker compose -f .devcontainer/docker-compose.yml up -d --wait

      # --- 1. Root E2E (L1 Smoke/Critical Path) ---
      - name: Run Root E2E
        run: pytest tests/e2e
        env:
          APP_URL: http://localhost:5000

      # --- 2. API Local E2E (L3) ---
      - name: Run API Local E2E
        if: hashFiles('api/tests/e2e/') != ''
        run: pytest api/tests/e2e
        env:
          APP_URL: http://localhost:8000 # Targets Gateway directly

      # --- 3. Auth Local E2E (L3) ---
      - name: Run Auth Local E2E
        if: hashFiles('auth/tests/e2e/') != ''
        run: pytest auth/tests/e2e
        env:
          AUTH_URL: http://localhost:9000 # Targets Auth Service directly

  # Job 7: Performance Matrix (L5) - Unchanged
  test-performance:
    needs: changed-files
    if: ${{ needs.changed-files.outputs.performance == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/novaeco-tech/dev-python:latest
      options: --user root
    strategy:
      matrix:
        component: [api, auth]
    steps:
      - uses: actions/checkout@v4
      - name: Install Dependencies
        run: |
          if [ -f ${{ matrix.component }}/requirements-dev.txt ]; then
            pip install -r ${{ matrix.component }}/requirements-dev.txt
          fi
      - name: Run Micro-benchmarks
        run: |
          if [ -d "${{ matrix.component }}/tests/performance" ]; then
            cd ${{ matrix.component }} && pytest tests/performance
          else
            echo "No performance tests found for ${{ matrix.component }}"
          fi