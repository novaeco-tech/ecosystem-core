# description: Packages Auth service and Auth Client SDK using standard CLI tools. Signals NovaEco QA.
name: Publish Auth Artifact

on:
  push:
    branches: [ main ]
    paths: [ 'auth/**' ]
  workflow_dispatch:

permissions:
  contents: write # Required to create tags and releases
  packages: write # Required if you were pushing to GHCR/PyPI (future proofing)

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    container:
      # Use the Golden Image which contains Python, Pip, and Protoc
      image: ghcr.io/novaeco-tech/dev-python:latest
      options: --user root # Required to write artifacts to the mounted volume
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed to check existing tags

      # 0. Install NovaEco CLI (Critical First Step)
      # This pulls the logic for 'novaeco build' from your devtools repo
      - name: Install NovaEco CLI
        run: pip install "git+https://github.com/novaeco-tech/novaeco-devtools.git@main#subdirectory=novaeco-cli"

      # 1. Check if Version Bumped
      - name: Check Version & Tag
        id: check
        run: |
          VERSION=$(cat auth/VERSION)
          TAG_NAME="novaeco-auth-v$VERSION"
          
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists. Skipping release."
            echo "SHOULD_RELEASE=false" >> $GITHUB_OUTPUT
          else
            echo "New version detected ($VERSION). Proceeding."
            echo "SHOULD_RELEASE=true" >> $GITHUB_OUTPUT
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          fi

      # 2. Defensive Testing
      # Restricted to unit tests to avoid failing on integration tests (which need Keycloak)
      - name: Install & Test
        if: steps.check.outputs.SHOULD_RELEASE == 'true'
        run: |
          pip install -r auth/requirements-dev.txt
          cd auth && pytest tests/unit

      # 3. Build Service Package (The Dockerable Code)
      - name: Build Service Artifact
        if: steps.check.outputs.SHOULD_RELEASE == 'true'
        run: |
          # Usage: novaeco build service --src-dir <path> --out-dir <path>
          cd auth
          novaeco build service --src-dir src --out-dir ../dist

      # 4. Build Client SDK (The gRPC Library for other sectors)
      # This corresponds to Step 1c: "novaeco-auth-client is the internal ProtoBuf auth client"
      - name: Build Client SDK
        if: steps.check.outputs.SHOULD_RELEASE == 'true'
        run: |
          # Usage: novaeco build client --proto-dir <path> --out-dir <path>
          cd auth
          novaeco build client \
            --proto-dir api/proto/v1 \
            --out-dir ../dist \
            --service-name novaeco-auth

      # 5. Generate QA Token
      - name: Generate QA Token
        if: steps.check.outputs.SHOULD_RELEASE == 'true'
        id: generate_qa_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.QA_APP_ID }}
          private-key: ${{ secrets.QA_APP_PRIVATE_KEY }}
          owner: novaeco-tech

      # 6. Create Release & Tag
      - name: Create GitHub Release
        if: steps.check.outputs.SHOULD_RELEASE == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "NovaEco Core Auth v${{ env.VERSION }}"
          files: |
            dist/novaeco-auth.tar.gz
            dist/*.whl
          prerelease: true
          generate_release_notes: true

      # 7. Signal QA
      - name: Dispatch to NovaEco QA
        if: steps.check.outputs.SHOULD_RELEASE == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ steps.generate_qa_token.outputs.token }}
          repository: novaeco-tech/novaeco-qa
          event-type: qa-trigger
          client-payload: >-
            {
              "component": "novaeco-auth",
              "version": "${{ env.TAG_NAME }}",
              "category": "core",
              "artifacts": ["novaeco-auth.tar.gz", "novaeco-auth-client.whl"]
            }