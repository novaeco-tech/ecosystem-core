# description: Runs tests on changes. Triggers on PRs, commits to main, and manually.
name: CI

on:
  pull_request:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Enables the "Run workflow" button

jobs:
  # Job 1: Detect changes
  changed-files:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      app: ${{ steps.filter.outputs.app }}
      auth: ${{ steps.filter.outputs.auth }}
      website: ${{ steps.filter.outputs.website }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            api: ['api/**', 'tests/integration/**']
            app: ['app/**', 'tests/integration/**']
            auth: ['auth/**', 'tests/integration/**']
            website: ['website/**']

  # Job 2: Test API (Python)
  test-api:
    needs: changed-files
    # Run if changed OR if triggered manually (manual runs usually want to test everything)
    if: ${{ needs.changed-files.outputs.api == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    container: ghcr.io/nova-ecosystem/dev-python:latest
    steps:
      - uses: actions/checkout@v4
      - run: pip install -r api/requirements.txt
      - run: cd api && pytest

  # Job 3: Test App (Python)
  test-app:
    needs: changed-files
    if: ${{ needs.changed-files.outputs.app == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    container: ghcr.io/nova-ecosystem/dev-python:latest
    steps:
      - uses: actions/checkout@v4
      - run: pip install -r app/requirements.txt
      - run: cd app && pytest

  # Job 4: Test Auth (Python)
  test-auth:
    needs: changed-files
    if: ${{ needs.changed-files.outputs.auth == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    container: ghcr.io/nova-ecosystem/dev-python:latest
    steps:
      - uses: actions/checkout@v4
      - run: pip install -r auth/requirements.txt
      - run: cd auth && pytest

  # Job 5: Test Website (Node.js)
  test-website:
    needs: changed-files
    if: ${{ needs.changed-files.outputs.website == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    container: ghcr.io/nova-ecosystem/dev-node:latest
    steps:
      - uses: actions/checkout@v4
      - run: cd website && npm install
      - run: cd website && npm test